<?xml version="1.0" encoding="utf-8" ?>
<UserControl
    x:Class="INotify.View.NotificationListControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:INotify.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:entity="using:INotifyLibrary.Model.Entity"
    xmlns:local="using:INotify.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:model="using:INotifyLibrary.Model"
    xmlns:viewModel="using:INotify.KToastView.Model"
    Loaded="UserControl_Loaded"
    Unloaded="UserControl_Unloaded"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
        <converters:CountToReverseVisibilityConverter x:Key="CountToReverseVisibilityConverter" />
        <converters:ExpandCollapseIconConverter x:Key="ExpandCollapseIconConverter" />

        <!--  CollectionViewSource for grouped packages  -->
        <CollectionViewSource
            x:Key="GroupedPackagesSource"
            x:Name="GroupedPackagesSource"
            IsSourceGrouped="True"
            Source="{x:Bind _viewModel.GroupedPackageNotifications, Mode=OneWay}" />
        <Style
            x:Key="ListViewGroupStyleHeaderContainerTemplate"
            x:Name="GrpStyle"
            TargetType="ListViewHeaderItem">
            <Setter Property="FontSize" Value="16" />
            <Setter Property="IsTabStop" Value="False" />
            <Setter Property="Margin" Value="0,0,0,0" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="MinHeight" Value="0" />
            <Setter Property="UseSystemFocusVisuals" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate x:Name="HeadTemplate" TargetType="ListViewHeaderItem">
                        <Grid>
                            <ContentPresenter
                                x:Name="ContentPresenter"
                                Padding="0,0,0,0"
                                HorizontalAlignment="{TemplateBinding HorizontalAlignment}"
                                HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                Content="{TemplateBinding Content}"
                                ContentTemplate="{TemplateBinding ContentTemplate}"
                                ContentTransitions="{TemplateBinding ContentTransitions}" />
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Notification Item Template  -->
        <DataTemplate x:Key="NotificationItemTemplate" x:DataType="model:KToastBObj">
            <Border
                Margin="0,4"
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  App Icon  -->
                    <!--
                    <Image
                        Grid.Column="0"
                        Width="32"
                        Height="32"
                        Margin="0,0,12,0"
                        Source="{x:Bind ToastPackageProfile.LogoFilePath, Mode=OneWay}" />-->

                    <!--  Notification Content  -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock
                            FontWeight="SemiBold"
                            Text="{x:Bind NotificationData.NotificationTitle, Mode=OneWay}"
                            TextTrimming="CharacterEllipsis"
                            Visibility="Collapsed" />
                        <TextBlock
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorPrimary}"
                            Text="{x:Bind NotificationData.NotificationMessage, Mode=OneWay}"
                            TextWrapping="WrapWholeWords" />
                        <TextBlock
                            Margin="0,4,0,0"
                            FontSize="14"
                            FontStyle="Normal"
                            FontWeight="Bold"
                            Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                            Text="{x:Bind ToastPackageProfile.AppDisplayName, Mode=OneWay}" />
                    </StackPanel>

                    <!--  Time  -->
                    <TextBlock
                        Grid.Column="2"
                        VerticalAlignment="Top"
                        FontSize="11"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Text="{x:Bind NotificationData.DisplayTime, Mode=OneWay}" />
                </Grid>
            </Border>
        </DataTemplate>

        <!--  Package Header Template for Grouped View  -->
        <DataTemplate x:Key="PackageGroupHeaderTemplate" x:DataType="viewModel:KPackageNotificationGroup">
            <Border
                Margin="0,8,0,4"
                Padding="16,12"
                Background="{ThemeResource ListViewGroupHeaderForegroundThemeBrush}"
                CornerRadius="8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  App Icon  -->
                    <!--<Image
                        Grid.Column="0"
                        Width="40"
                        Height="40"
                        Margin="0,0,16,0"
                        Source="{x:Bind IconPath, Mode=OneWay}" />-->

                    <!--  Package Info  -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock
                            FontWeight="SemiBold"
                            FontSize="16"
                            Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                            Text="{x:Bind DisplayName, Mode=OneWay}"
                            TextTrimming="CharacterEllipsis" />
                        <TextBlock
                            FontSize="12"
                            Foreground="{ThemeResource TextOnAccentFillColorSecondaryBrush}"
                            Text="{x:Bind NotificationCountText, Mode=OneWay}" />
                    </StackPanel>

                    <!--  Notification Count Badge  -->
                    <Grid
                        Grid.Column="2"
                        Height="32"
                        Width="32"
                        Margin="0,0,8,0"
                        Padding="0"
                        Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}"
                        CornerRadius="16"
                        Visibility="{x:Bind NotificationCount, Converter={StaticResource CountToReverseVisibilityConverter}, Mode=OneWay}">
                        <TextBlock
                            FontSize="16"
                            Margin="0 0 0 2"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="{x:Bind NotificationCount, Mode=OneWay}"
                            Foreground="{ThemeResource TextFillColorPrimaryBrush}" />
                    </Grid>

                    <!--  Clear Notifications Button  -->
                    <Button
                        Grid.Column="3"
                        Width="32"
                        Height="32"
                        Padding="0"
                        Margin="0,0,8,0"
                        Background="Transparent"
                        Click="ClearPackageNotifications_Click"
                        Tag="{x:Bind}"
                        Style="{StaticResource AccentButtonStyle}"
                        ToolTipService.ToolTip="Clear all notifications for this package">
                        <FontIcon           
                            FontSize="16"
                            Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                            Glyph="&#xE74D;" />
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>

        <!--  Package Item Template (Simple)  -->
        <DataTemplate x:Key="PackageItemTemplate" x:DataType="entity:KPackageProfile">
            <Border
                Margin="0,4"
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  App Icon  -->
                    <Image
                        Grid.Column="0"
                        Width="40"
                        Height="40"
                        Margin="0,0,16,0"
                        Source="{x:Bind LogoFilePath, Mode=OneWay}" />

                    <!--  Package Content  -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock
                            FontWeight="SemiBold"
                            Text="{x:Bind AppDisplayName, Mode=OneWay}"
                            TextTrimming="CharacterEllipsis" />
                        <TextBlock
                            FontSize="12"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="{x:Bind AppDescription, Mode=OneWay}"
                            TextTrimming="CharacterEllipsis" />
                    </StackPanel>

                    <!--  Package ID  -->
                    <TextBlock
                        Grid.Column="2"
                        VerticalAlignment="Center"
                        FontSize="10"
                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                        Text="{x:Bind PackageFamilyName, Mode=OneWay}" />
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid Margin="0,8,0,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Header Section  -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  Title and Count  -->
            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock
                    FontSize="20"
                    FontWeight="SemiBold"
                    Text="{x:Bind _viewModel.ViewDisplayText, Mode=OneWay}" />
                <TextBlock
                    FontSize="12"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="{x:Bind CurrentTargetType, Mode=OneWay}" />
            </StackPanel>

            <!--  Go to Button (Only visible in Package View)  -->
            <Button
                x:Name="GoToButton"
                Grid.Column="1"
                Margin="0,0,8,0"
                Content="Go to"
                Visibility="{x:Bind TogglePackageView(_viewModel.IsPackageView), Mode=OneWay}">
                <Button.Flyout>
                    <Flyout x:Name="NavigationFlyout" Placement="Bottom">
                        <Grid Width="200" MaxHeight="300">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <TextBlock
                                Margin="0,0,0,8"
                                FontWeight="SemiBold"
                                Text="Go to Package:" />
                            <ListView
                                x:Name="NavigationPackagesList"
                                Grid.Row="1"
                                ItemsSource="{x:Bind _viewModel.NavigationPackages, Mode=OneWay}"
                                SelectionChanged="NavigationPackagesList_SelectionChanged"
                                SelectionMode="Single">
                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="viewModel:KPackageNotificationGroup">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock
                                                FontWeight="SemiBold"
                                                Text="{x:Bind DisplayName, Mode=OneWay}"
                                                TextTrimming="CharacterEllipsis" />
                                            <Border
                                                Padding="4,2"
                                                Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                CornerRadius="8">
                                                <TextBlock
                                                    FontSize="10"
                                                    Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                                                    Text="{x:Bind NotificationCount, Mode=OneWay}" />
                                            </Border>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="8,4" />
                                        <Setter Property="CornerRadius" Value="7"/>
                                    </Style>
                                </ListView.ItemContainerStyle>
                            </ListView>

                        </Grid>
                    </Flyout>
                </Button.Flyout>
            </Button>

            <!--  Toggle View Button  -->
            <Button
                Grid.Column="2"
                Margin="0,0,8,0"
                Click="ToggleViewButton_Click"
                Content="{x:Bind _viewModel.ToggleButtonText, Mode=OneWay}"
                Style="{ThemeResource AccentButtonStyle}" />

            <!--  Refresh Button  -->
            <Button Grid.Column="3" Click="RefreshButton_Click">
                <FontIcon FontSize="16" Glyph="&#xE72C;" />
            </Button>
        </Grid>

        <!--  Content Section  -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <!--  Loading Indicator  -->
            <ProgressRing
                Width="50"
                Height="50"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                IsActive="{x:Bind _viewModel.IsLoading, Mode=OneWay}"
                Visibility="{x:Bind _viewModel.IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, Mode=OneWay}" />

            <!--  Notifications ListView  -->
            <ListView
                Grid.Row="1"
                IsItemClickEnabled="True"
                ItemTemplate="{StaticResource NotificationItemTemplate}"
                ItemsSource="{x:Bind _viewModel.Notifications, Mode=OneWay}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                ScrollViewer.HorizontalScrollMode="Disabled"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                ScrollViewer.VerticalScrollMode="Auto"
                SelectionMode="None"
                Visibility="{x:Bind ToggleNotificationView(_viewModel.IsPackageView), Mode=OneWay}">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0" />
                    </Style>
                </ListView.ItemContainerStyle>
            </ListView>

            <!--  Grouped Packages ListView  -->
            <ListView
                x:Name="GroupedPackagesListView"
                Grid.Row="1"
                IsItemClickEnabled="False"
                ItemTemplate="{StaticResource NotificationItemTemplate}"
                ItemsSource="{x:Bind GroupedPackagesSource.View, Mode=OneWay}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                ScrollViewer.HorizontalScrollMode="Disabled"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                ScrollViewer.VerticalScrollMode="Auto"
                SelectionMode="None"
                Visibility="{x:Bind TogglePackageView(_viewModel.IsPackageView), Mode=OneWay}">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0,0,0,8" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.GroupStyle>
                    <GroupStyle
                        HeaderContainerStyle="{StaticResource ListViewGroupStyleHeaderContainerTemplate}"
                        HeaderTemplate="{StaticResource PackageGroupHeaderTemplate}"
                        HidesIfEmpty="False" />
                </ListView.GroupStyle>
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel AreStickyGroupHeadersEnabled="True" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
            </ListView>

            <!--  Empty State  -->
            <StackPanel
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Visibility="{x:Bind _viewModel.TotalCount, Converter={StaticResource CountToVisibilityConverter}, Mode=OneWay}">
                <TextBlock
                    Margin="0,0,0,8"
                    HorizontalAlignment="Center"
                    FontSize="18"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="No items found" />
                <TextBlock
                    HorizontalAlignment="Center"
                    FontSize="12"
                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                    Text="Try adjusting your filters or check back later" />
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
